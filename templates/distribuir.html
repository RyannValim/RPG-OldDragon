<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Distribua seus Atributos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h2>Distribua seus Atributos</h2>
        <p>Valores rolados: <strong>{{ rolagens | join(', ') }}</strong></p>

        {% if erro %}
            <p style="color: red;">{{ erro }}</p>
        {% endif %}

        <form action="/finalizar_personagem" method="POST">
            {% for attr in ["FOR", "DES", "CON", "INT", "SAB", "CAR"] %}
            <p>
                <label for="{{ attr }}">{{ attr }}:</label>
                <select id="{{ attr }}" name="{{ attr }}" required>
                    <option value="" disabled selected>Escolha um valor...</option>
                    {% for valor in rolagens %}
                    <option value="{{ valor }}">{{ valor }}</option>
                    {% endfor %}
                </select>
            </p>
            {% endfor %}

            <button type="submit">Finalizar Personagem</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            const rolagens = {{ rolagens | tojson }};
            const selects = document.querySelectorAll('select');

            function updateOptions() {
                const rolagensCount = rolagens.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});

                const selectedValues = Array.from(selects)
                                            .map(s => s.value)
                                            .filter(v => v !== "");

                const selectedCount = selectedValues.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});

                selects.forEach(select => {
                    const currentValue = select.value;
                    
                    select.querySelectorAll('option').forEach(option => {
                        if (option.value === "") return;

                        const optionValue = option.value;
                        const totalAvailable = rolagensCount[optionValue] || 0;
                        const totalUsed = selectedCount[optionValue] || 0;

                        if (totalUsed >= totalAvailable && optionValue !== currentValue) {
                            option.disabled = true;
                        } else {
                            option.disabled = false;
                        }
                    });
                });
            }

            selects.forEach(select => {
                select.addEventListener('change', updateOptions);
            });

            updateOptions();
        });
    </script>
</body>
</html>