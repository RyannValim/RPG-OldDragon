<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Distribua seus Atributos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h2>Distribua seus Atributos</h2>
        <p>Valores rolados: <strong>{{ rolagens | join(', ') }}</strong></p>

        {% if erro %}
            <p style="color: red;">{{ erro }}</p>
        {% endif %}

        <form action="/finalizar_personagem" method="POST">
            {% for attr in ["FOR", "DES", "CON", "INT", "SAB", "CAR"] %}
            <p>
                <label for="{{ attr }}">{{ attr }}:</label>
                <select id="{{ attr }}" name="{{ attr }}" required>
                    <option value="" disabled selected>Escolha um valor...</option>
                    {% for valor in rolagens %}
                    <option value="{{ valor }}">{{ valor }}</option>
                    {% endfor %}
                </select>
            </p>
            {% endfor %}

            <button type="submit">Finalizar Personagem</button>
        </form>
    </div>

    <script>
        // Este evento garante que nosso código só vai rodar depois que a página inteira for carregada.
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Pegamos os valores rolados do Python e os transformamos em uma variável JavaScript.
            // O filtro `tojson` é a forma segura de fazer isso no Flask/Jinja2.
            const rolagens = {{ rolagens | tojson }};
            const selects = document.querySelectorAll('select'); // Pega todos os 6 menus suspensos.

            // 2. Criamos uma função para atualizar as opções cada vez que uma seleção é feita.
            function updateOptions() {
                // Conta quantas vezes cada valor foi rolado originalmente.
                const rolagensCount = rolagens.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});

                // Pega todos os valores que já foram selecionados nos menus.
                const selectedValues = Array.from(selects)
                                            .map(s => s.value)
                                            .filter(v => v !== ""); // Ignora os não selecionados

                // Conta quantas vezes cada valor já foi usado.
                const selectedCount = selectedValues.reduce((acc, val) => {
                    acc[val] = (acc[val] || 0) + 1;
                    return acc;
                }, {});

                // 3. Itera em cada menu suspenso para habilitar/desabilitar as opções.
                selects.forEach(select => {
                    const currentValue = select.value; // O valor atualmente selecionado neste menu.
                    
                    // Itera em cada <option> dentro do menu.
                    select.querySelectorAll('option').forEach(option => {
                        if (option.value === "") return; // Ignora a opção "Escolha um valor..."

                        const optionValue = option.value;
                        const totalAvailable = rolagensCount[optionValue] || 0;
                        const totalUsed = selectedCount[optionValue] || 0;

                        // Desabilita a opção se já foi usada o máximo de vezes disponíveis.
                        // A exceção é a própria seleção atual deste menu.
                        if (totalUsed >= totalAvailable && optionValue !== currentValue) {
                            option.disabled = true;
                        } else {
                            option.disabled = false;
                        }
                    });
                });
            }

            // 4. Adiciona um "ouvinte" de evento a cada menu.
            // A função `updateOptions` será chamada toda vez que o usuário mudar uma seleção.
            selects.forEach(select => {
                select.addEventListener('change', updateOptions);
            });

            // Chama a função uma vez no início para garantir o estado inicial correto.
            updateOptions();
        });
    </script>
</body>
</html>